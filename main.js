(()=>{"use strict";const e=async e=>{const{url:t,method:s="GET",data:n={},headers:o={}}=e;try{const e=await fetch(t,{method:s,headers:{"Content-Type":"application/json",...o},body:"GET"!==s?JSON.stringify(n):void 0});if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return await e.json()}catch(e){throw console.error("Error with request:",e),e}};class t{constructor(e){this.baseUrl=e}async list(){try{return await e({url:`${this.baseUrl}`,method:"GET"})}catch(e){throw console.error("Error fetching list:",e),e}}async get(t){try{return await e({url:`${this.baseUrl}/${t}`,method:"GET"})}catch(e){throw console.error("Error fetching item:",e),e}}async create(t){try{return await e({url:`${this.baseUrl}/new-user`,method:"POST",data:t})}catch(e){throw console.error("Error creating item:",e),e}}async update(t,s){try{return await e({url:`${this.baseUrl}/${t}`,method:"PUT",data:s})}catch(e){throw console.error("Error updating item:",e),e}}async delete(t){try{return await e({url:`${this.baseUrl}/${t}`,method:"DELETE"})}catch(e){throw console.error("Error deleting item:",e),e}}}const s="https://chatserver-production-5893.up.railway.app";class n extends t{constructor(){super(s),this.ws=null,this.user=null}async registerUser(t){console.log("Registering user:",t);try{const s=await e({url:`${this.baseUrl}/new-user`,method:"POST",data:{name:t}});if(console.log("User registration response:",s),"ok"===s.status)return this.user=s.user,console.log("User registered successfully:",this.user),this.connectWebSocket(),s.user;throw new Error(s.message)}catch(e){throw console.error("Failed to register user:",e),e}}connectWebSocket(){const e=s.replace(/^https/,"wss");console.log("Connecting to WebSocket:",e),this.ws?console.log("WebSocket already connected."):(this.ws=new WebSocket(e),this.ws.addEventListener("open",(()=>{console.log("WebSocket connection opened.")})),this.ws.addEventListener("message",(e=>{console.log("WebSocket message received:",e.data);const t=JSON.parse(e.data);this.handleWebSocketMessage(t)})),this.ws.addEventListener("close",(()=>{console.log("WebSocket connection closed."),this.ws=null})),this.ws.addEventListener("error",(e=>{console.error("WebSocket error:",e)})))}handleWebSocketMessage(e){console.log("Handling WebSocket message:",e),Array.isArray(e)?(console.log("User list updated:",e),document.dispatchEvent(new CustomEvent("userListUpdate",{detail:e}))):"send"===e.type&&"requestUserList"===e.content?.type?this.addUserToList(e.user):"send"===e.type&&"removeUser"===e.content?.type?document.dispatchEvent(new CustomEvent("removeUser",{detail:e.content})):"send"===e.type?this.handleNewMessage(e):"exit"===e.type?(this.exitChat(),console.log("User exited:",e.user),document.dispatchEvent(new CustomEvent("removeUser",{detail:e.user}))):console.error("Received invalid WebSocket message:",e)}addUserToList(e){console.log("Adding new user to list:",e),document.dispatchEvent(new CustomEvent("addUser",{detail:e}))}removeUserFromList(e){console.log("Removing user with ID:",e),document.dispatchEvent(new CustomEvent("removeUser",{detail:{userId:e}}))}async requestUserList(){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const e={type:"exit"};this.sendMessage(e)}else console.error("WebSocket is not connected.")}handleNewMessage(e){console.log("New message received:",e),document.dispatchEvent(new CustomEvent("newMessage",{detail:e}))}sendMessage(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return void console.error("WebSocket is not connected.");console.log("Sending message:",e);const t={type:"send",user:this.user,content:e};this.ws.send(JSON.stringify(t))}exitChat(){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const e={type:"exit",user:this.user};this.ws.send(JSON.stringify(e)),this.ws.close()}else console.error("WebSocket is not connected.")}}const o=document.getElementById("root"),r=new class{constructor(e){this.container=e,this.api=new n,this.user=null,this.isSubscribed=!1}init(){this.bindToDOM(),this.registerEvents()}bindToDOM(){this.container.innerHTML='\n      <div class="chat__container">\n        <ul class="chat__userlist" id="userList"></ul>\n        <div class="chat__area">\n          <div class="chat__messages-container" id="messagesContainer"></div>\n          <div class="chat__messages-input">\n            <input type="text" id="messageInput" class="form__input" placeholder="Type your message here">\n          </div>\n        </div>\n      </div>\n    '}registerEvents(){this.container.querySelector("#messageInput").addEventListener("keypress",(e=>{"Enter"===e.key&&""!==e.target.value.trim()&&(console.log("Sending message:",e.target.value),this.sendMessage(e.target.value),e.target.value="")})),this.subscribeOnEvents()}subscribeOnEvents(){this.api.ws&&this.api.ws.readyState===WebSocket.OPEN?console.log("WebSocket is already connected."):(console.log("WebSocket is not open. Attempting to connect..."),this.api.connectWebSocket()),this.isSubscribed||(document.addEventListener("userListUpdate",(e=>{console.log("User list update event received:",e.detail),this.updateUserList(e.detail)})),document.addEventListener("addUser",(e=>{console.log("Add user event received:",e.detail),this.addUser(e.detail)})),document.addEventListener("newMessage",(e=>{const{content:t,user:s}=e.detail;this.renderMessage(t,s)})),document.addEventListener("removeUser",(e=>{const{userId:t}=e.detail;console.log("Remove user event received for userId:",t),this.requestUpdatedUserList()})),this.isSubscribed=!0)}addUser(e){console.log("Adding user:",e);const t=document.querySelector("#userList");if(!t)return void console.error("User list element not found.");const s=document.createElement("li");s.textContent=e.name,t.appendChild(s)}async onEnterChatHandler(e){console.log("Entering chat with nickname:",e);try{const t=await this.api.registerUser(e);t?(this.user=t,document.querySelector(".modal__form").classList.remove("active"),this.api.ws&&this.api.ws.readyState===WebSocket.OPEN?(console.log("Requesting user list..."),this.api.sendMessage({type:"requestUserList"})):console.error("WebSocket is not connected or not open."),this.subscribeOnEvents()):document.getElementById("errorHint").textContent="Ошибка регистрации пользователя"}catch(e){console.error("Error entering chat:",e)}}requestUpdatedUserList(){this.api.ws&&this.api.ws.readyState===WebSocket.OPEN?this.api.sendMessage({type:"requestUserList"}):console.error("WebSocket is not connected or not open.")}onExitChatHandler(){this.user&&(console.log("Exiting chat for user:",this.user.name),this.api.ws&&this.api.ws.readyState===WebSocket.OPEN?this.api.sendMessage({type:"removeUser",userId:this.user.id}):console.error("WebSocket is not connected or not open."))}sendMessage(e){console.log("Sending message:",e),this.api.sendMessage(e)}renderMessage(e,t){const s=this.container.querySelector("#messagesContainer"),n=document.createElement("div");n.className=t.name===this.user.name?"message__container-yourself":"message__container-interlocutor",n.innerHTML=`\n      <div class="message__header">${t.name===this.user.name?"You":t.name}, ${(new Date).toLocaleString()}</div>\n      <div class="message__text">${e}</div>\n    `,s.appendChild(n),s.scrollTop=s.scrollHeight}updateUserList(e){console.log("Updating user list:",e);const t=document.querySelector("#userList");t?(t.innerHTML="",e.forEach((e=>{if(e.name){const s=document.createElement("li");s.textContent=e.name,s.dataset.userId=e.id,t.appendChild(s)}else console.error("User object does not have a name property:",e)}))):console.error("User list element not found.")}removeUserFromList(e){console.log("Removing user with ID:",e);const t=document.querySelector("#userList");if(!t)return void console.error("User list element not found.");Array.from(t.children).forEach((s=>{s.dataset.userId===e&&t.removeChild(s)}))}exitChat(){console.log("Exiting chat."),this.api.ws&&this.api.ws.readyState===WebSocket.OPEN?this.user&&this.api.ws.send(JSON.stringify({type:"exit",user:this.user})):console.error("WebSocket is not connected or not open."),this.updateUserList([]),this.api.exitChat()}}(o);document.addEventListener("DOMContentLoaded",(()=>{const e=document.createElement("div");e.className="modal__form active",e.innerHTML='\n    <div class="modal__background"></div>\n    <div class="modal__content">\n      <div class="modal__header">Выберите псевдоним</div>\n      <div class="modal__body">\n        <div class="form__group">\n          <label class="form__label">Псевдоним:</label>\n          <input type="text" class="form__input" id="nicknameInput">\n        </div>\n        <div class="form__hint" id="errorHint"></div>\n      </div>\n      <div class="modal__footer">\n        <button class="modal__ok" id="continueButton">Продолжить</button>\n      </div>\n    </div>\n  ',document.body.appendChild(e);const t=document.getElementById("nicknameInput");document.getElementById("continueButton").addEventListener("click",(()=>{const e=t.value.trim();e?r.onEnterChatHandler(e):document.getElementById("errorHint").textContent="Пожалуйста, введите псевдоним."})),window.addEventListener("beforeunload",(()=>{r.onExitChatHandler()})),r.init()}))})();